services:
  # PostgreSQL Database
  db:
    image: postgres:18-alpine
    environment:
      POSTGRES_PASSWORD: vikunja
      POSTGRES_USER: vikunja
      POSTGRES_DB: vikunja
    volumes:
      - vikunja-db:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vikunja"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Garnet (Redis-compatible cache)
  cache:
    image: ghcr.io/microsoft/garnet:latest
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c 'cat < /dev/null > /dev/tcp/localhost/6379'"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: vikunja
      MINIO_ROOT_PASSWORD: vikunja123
    volumes:
      - vikunja-minio:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # MinIO bucket initialization
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 vikunja vikunja123;
      mc mb myminio/vikunja --ignore-existing;
      mc anonymous set public myminio/vikunja;
      exit 0;
      "
    restart: "no"

  # Vikunja Task Management
  vikunja:
    image: vikunja/vikunja:latest
    environment:
      VIKUNJA_DATABASE_TYPE: postgres
      VIKUNJA_DATABASE_HOST: db
      VIKUNJA_DATABASE_USER: vikunja
      VIKUNJA_DATABASE_PASSWORD: vikunja
      VIKUNJA_DATABASE_DATABASE: vikunja
      VIKUNJA_SERVICE_PUBLICURL: http://localhost:8080
      VIKUNJA_SERVICE_FRONTENDURL: http://localhost:8080
      
      # Redis/Garnet cache
      VIKUNJA_REDIS_ENABLED: "true"
      VIKUNJA_REDIS_HOST: cache:6379
      
      # S3/MinIO storage (enabled by default)
      VIKUNJA_FILES_S3_ENABLED: "true"
      VIKUNJA_FILES_S3_ENDPOINT: minio:9000
      VIKUNJA_FILES_S3_ACCESSKEYID: vikunja
      VIKUNJA_FILES_S3_SECRETACCESSKEY: vikunja123
      VIKUNJA_FILES_S3_BUCKET: vikunja
      VIKUNJA_FILES_S3_USESSL: "false"
      
      # Mailer configuration (disabled by default)
      # VIKUNJA_MAILER_ENABLED: "true"
      # VIKUNJA_MAILER_HOST: smtp.example.com
      # VIKUNJA_MAILER_PORT: 587
      # VIKUNJA_MAILER_USERNAME: user@example.com
      # VIKUNJA_MAILER_PASSWORD: password
      # VIKUNJA_MAILER_FROMEMAIL: vikunja@example.com
      # VIKUNJA_MAILER_SKIPTLSVERIFY: "false"
      
      # Webhooks
      VIKUNJA_WEBHOOKS_ENABLED: "true"
    ports:
      - "8080:3456"
    tmpfs:
      - /app/vikunja/files:uid=1000,gid=1000
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3456/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # VikunjaHook MCP Server
  vikunja-hook:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      VIKUNJA_API_URL: http://vikunja:3456/api/v1
      VIKUNJA_API_TOKEN: ${VIKUNJA_API_TOKEN}
      ASPNETCORE_URLS: http://+:5082
    ports:
      - "5082:5082"
    depends_on:
      vikunja:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5082/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  vikunja-db:
  vikunja-minio:
