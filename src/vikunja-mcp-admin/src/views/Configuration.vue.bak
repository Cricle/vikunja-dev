<template>
  <div class="dashboard">
    <h1 class="page-title">Dashboard</h1>

    <!-- Server Status Card -->
    <div class="card">
      <div class="card-header">
        <h2>Server Status</h2>
      </div>
      <div class="card-body">
        <div v-if="serverStore.loading" class="loading">
          <div class="spinner"></div>
          <span>Loading...</span>
        </div>
        <div v-else-if="serverStore.health" class="status-grid">
          <div class="status-item">
            <div class="label">Status</div>
            <div class="value">
              <span class="badge badge-success">{{ serverStore.health.status }}</span>
            </div>
          </div>
          <div class="status-item">
            <div class="label">Server</div>
            <div class="value">{{ serverStore.health.server }}</div>
          </div>
          <div class="status-item">
            <div class="label">Version</div>
            <div class="value">{{ serverStore.health.version }}</div>
          </div>
          <div class="status-item">
            <div class="label">Last Check</div>
            <div class="value">{{ formatDate(serverStore.health.timestamp) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-value">{{ serverStore.tools.length }}</div>
          <div class="stat-label">Registered Tools</div>
        </div>
      </div>

      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-value">{{ totalSubcommands }}</div>
          <div class="stat-label">Total Subcommands</div>
        </div>
      </div>

      <div class="card stat-card">
        <div class="card-body">
          <div class="stat-value">60/min</div>
          <div class="stat-label">Rate Limit</div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header">
        <h2>Quick Actions</h2>
      </div>
      <div class="card-body">
        <div class="actions">
          <button class="btn btn-secondary" @click="refreshData">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M13.5 2.5L13.5 6.5L9.5 6.5" />
              <path d="M13 6C12.5 4.5 11.5 3.2 10 2.5C7 1 3.5 2 2 5C0.5 8 1.5 11.5 4.5 13C7.5 14.5 11 13.5 12.5 10.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
            Refresh Status
          </button>
          <router-link to="/config" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 10.5C9.38071 10.5 10.5 9.38071 10.5 8C10.5 6.61929 9.38071 5.5 8 5.5C6.61929 5.5 5.5 6.61929 5.5 8C5.5 9.38071 6.61929 10.5 8 10.5Z"/>
              <path d="M13.5 8.5L14.5 9.5L13 11L11.5 10.5L10.5 11.5L10.5 13.5L8.5 14.5L7.5 13.5L6.5 13.5L5.5 14.5L3.5 13.5L3.5 11.5L2.5 10.5L1 11L0 9.5L1 8.5L1 7.5L0 6.5L1 5L2.5 5.5L3.5 4.5L3.5 2.5L5.5 1.5L6.5 2.5L7.5 2.5L8.5 1.5L10.5 2.5L10.5 4.5L11.5 5.5L13 5L14.5 6.5L13.5 7.5L13.5 8.5Z"/>
            </svg>
            Configure Server
          </router-link>
          <router-link to="/tools" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M14.5 7L11 3.5L9.5 5L11 6.5L8.5 9L7 7.5L1 13.5L2.5 15L8.5 9L10 10.5L14.5 6V7Z"/>
              <path d="M6 1L5 2L7 4L8 3L6 1Z"/>
            </svg>
            View Tools
          </router-link>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted } from 'vue'
import { useServerStore } from '../stores/server'

const serverStore = useServerStore()

const totalSubcommands = computed(() => {
  return serverStore.tools.reduce((sum, tool) => sum + tool.subcommands.length, 0)
})

function formatDate(dateString: string) {
  return new Date(dateString).toLocaleString()
}

async function refreshData() {
  await Promise.all([
    serverStore.checkHealth(),
    serverStore.fetchInfo(),
    serverStore.fetchTools()
  ])
}

onMounted(() => {
  refreshData()
})
</script>

<style scoped>
.dashboard {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.page-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--vscode-fg);
  margin: 0;
}

.card {
  background: var(--vscode-header-bg);
  border: 1px solid var(--vscode-border);
  border-radius: 6px;
  overflow: hidden;
}

.card-header {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--vscode-border);
}

.card-header h2 {
  font-size: 1rem;
  font-weight: 600;
  margin: 0;
  color: var(--vscode-fg);
}

.card-body {
  padding: 1.25rem;
}

.loading {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: var(--vscode-fg);
  opacity: 0.7;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--vscode-border);
  border-top-color: var(--vscode-blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.status-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.label {
  font-size: 0.875rem;
  color: var(--vscode-fg);
  opacity: 0.7;
}

.value {
  font-size: 1rem;
  color: var(--vscode-fg);
  font-weight: 500;
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.625rem;
  border-radius: 4px;
  font-size: 0.8125rem;
  font-weight: 500;
}

.badge-success {
  background: rgba(78, 201, 176, 0.15);
  color: var(--vscode-green);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.stat-card .card-body {
  text-align: center;
  padding: 2rem 1.25rem;
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 600;
  color: var(--vscode-blue);
  line-height: 1;
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.875rem;
  color: var(--vscode-fg);
  opacity: 0.7;
}

.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border: 1px solid var(--vscode-border);
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  background: transparent;
  color: var(--vscode-fg);
}

.btn:hover {
  background: var(--vscode-hover);
  border-color: var(--vscode-blue);
}

.btn-primary {
  background: var(--vscode-blue);
  border-color: var(--vscode-blue);
  color: #fff;
}

.btn-primary:hover {
  background: var(--vscode-blue-hover);
  border-color: var(--vscode-blue-hover);
}

.btn svg {
  width: 16px;
  height: 16px;
}

@media (max-width: 768px) {
  .status-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .actions {
    flex-direction: column;
  }

  .btn {
    width: 100%;
    justify-content: center;
  }
}
</style>
